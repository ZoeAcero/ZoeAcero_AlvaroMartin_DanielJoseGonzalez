<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Benchmark de Concurrencia</title>
    <!-- Carga de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
    </style>
</head>
<body class="p-4 sm:p-8 min-h-screen flex items-start justify-center">

<div class="w-full max-w-4xl bg-white shadow-2xl rounded-xl p-6 md:p-10">
    <header class="text-center mb-8">
        <h1 class="text-3xl font-bold text-gray-800 border-b pb-2">Benchmarking de Ejecución Concurrente en Java</h1>
        <p class="text-gray-500 mt-2">Compara el rendimiento de la ejecución secuencial, ExecutorService y Spring @Async.</p>
    </header>

    <!-- Formulario de Configuración del Benchmark -->
    <div class="bg-gray-50 p-6 rounded-lg shadow-inner mb-8">
        <h2 class="text-xl font-semibold mb-4 text-gray-700">Configuración de la Prueba</h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 items-end">
            <div>
                <label for="tasks" class="block text-sm font-medium text-gray-700 mb-1">Número de Tareas (N)</label>
                <input type="number" id="tasks" value="50" min="1" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150">
                <p class="text-xs text-gray-400 mt-1">Simulación de la carga de trabajo.</p>
            </div>
            <div>
                <label for="threads" class="block text-sm font-medium text-gray-700 mb-1">Hilos Máximos (P)</label>
                <input type="number" id="threads" value="4" min="1" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150">
                <p class="text-xs text-gray-400 mt-1">Número de hilos para ejecución concurrente.</p>
            </div>
            <div>
                <button id="startButton" onclick="startBenchmark()"
                        class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 rounded-lg transition duration-200 ease-in-out shadow-lg disabled:bg-gray-400">
                    Iniciar Benchmark
                </button>
            </div>
        </div>
    </div>

    <!-- Indicador de Carga y Mensajes -->
    <div id="messageBox" class="p-3 mb-6 hidden rounded-lg text-sm transition-all duration-300"></div>

    <!-- Resultados Generales -->
    <div id="summary" class="bg-blue-50 p-4 rounded-lg border border-blue-200 mb-8 hidden">
        <p class="font-bold text-blue-800">Tareas: <span id="totalTasks">0</span> | Hilos Utilizados: <span id="threadsUsed">0</span></p>
    </div>

    <!-- Tabla de Resultados -->
    <h2 class="text-xl font-semibold mb-4 text-gray-700">Resultados por Estrategia</h2>
    <div class="overflow-x-auto rounded-lg shadow-md border border-gray-200">
        <table class="min-w-full divide-y divide-gray-200" id="resultsTable">
            <thead class="bg-gray-100">
            <tr>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Modo de Ejecución</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Tiempo (ms)</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Aceleración (Speedup)</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Eficiencia</th>
            </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200" id="resultsBody">
            <!-- Filas generadas por JS -->
            <tr><td colspan="4" class="text-center py-4 text-gray-500">Haz clic en 'Iniciar Benchmark' para ver los resultados.</td></tr>
            </tbody>
        </table>
    </div>
</div>

<script>
    // URL base de la API de Spring Boot
    const API_BASE_URL = 'http://localhost:8080/benchmark';

    // Elementos del DOM
    const startButton = document.getElementById('startButton');
    const tasksInput = document.getElementById('tasks');
    const threadsInput = document.getElementById('threads');
    const messageBox = document.getElementById('messageBox');
    const resultsBody = document.getElementById('resultsBody');
    const summaryDiv = document.getElementById('summary');

    /**
     * Muestra un mensaje de estado o error en la caja de mensajes.
     * @param {string} text - El texto del mensaje.
     * @param {string} type - 'success', 'error', 'info', o 'loading'.
     */
    function displayMessage(text, type) {
        messageBox.classList.remove('hidden', 'bg-red-100', 'bg-green-100', 'bg-yellow-100');
        messageBox.classList.add('p-3', 'rounded-lg', 'text-sm');

        let bgColor = '';
        let textColor = '';

        switch (type) {
            case 'success':
                bgColor = 'bg-green-100';
                textColor = 'text-green-800';
                text = '✅ Éxito: ' + text;
                break;
            case 'error':
                bgColor = 'bg-red-100';
                textColor = 'text-red-800';
                text = '❌ Error: ' + text;
                break;
            case 'loading':
                bgColor = 'bg-yellow-100';
                textColor = 'text-yellow-800';
                text = '⏳ Procesando: ' + text;
                break;
            default:
                bgColor = 'bg-gray-100';
                textColor = 'text-gray-800';
        }

        messageBox.className = `p-3 mb-6 rounded-lg text-sm transition-all duration-300 ${bgColor} ${textColor}`;
        messageBox.innerHTML = text;
    }

    /**
     * Renderiza la tabla de resultados.
     * @param {Object} results - Objeto BenchmarkResult de la API.
     */
    function renderResults(results) {
        if (!results || !results.results || results.results.length === 0) {
            resultsBody.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-gray-500">No hay resultados disponibles.</td></tr>';
            summaryDiv.classList.add('hidden');
            return;
        }

        // 1. Actualizar Resumen
        document.getElementById('totalTasks').textContent = results.totalTasks;
        document.getElementById('threadsUsed').textContent = results.threadsUsed;
        summaryDiv.classList.remove('hidden');

        // 2. Generar Filas de la Tabla
        resultsBody.innerHTML = '';
        results.results.forEach(modeResult => {
            const row = document.createElement('tr');
            row.className = 'hover:bg-gray-50 transition duration-100';

            const efficiencyColor = modeResult.efficiency > 0.8 ? 'text-green-600 font-medium' :
                modeResult.efficiency > 0.5 ? 'text-yellow-600' : 'text-red-600';

            // Formatear el modo para mejor lectura
            let modeDisplayName = modeResult.mode.replace('_', ' ');
            modeDisplayName = modeDisplayName.charAt(0) + modeDisplayName.slice(1).toLowerCase();

            row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${modeDisplayName}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${modeResult.timeMs.toLocaleString()} ms</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${modeResult.speedup.toFixed(2)}x</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm ${efficiencyColor}">${(modeResult.efficiency * 100).toFixed(2)}%</td>
                `;
            resultsBody.appendChild(row);
        });
    }

    /**
     * Lanza la prueba de rendimiento mediante una petición POST.
     */
    async function startBenchmark() {
        const tasks = parseInt(tasksInput.value);
        const threads = parseInt(threadsInput.value);

        if (isNaN(tasks) || tasks <= 0 || isNaN(threads) || threads <= 0) {
            displayMessage('Por favor, introduce valores válidos para Tareas y Hilos.', 'error');
            return;
        }

        startButton.disabled = true;
        startButton.textContent = 'Procesando...';
        displayMessage(`Iniciando prueba con ${tasks} tareas y ${threads} hilos. Esto puede tardar varios segundos...`, 'loading');

        const url = `${API_BASE_URL}/start?tasks=${tasks}&threads=${threads}`;

        try {
            const response = await fetch(url, { method: 'POST' });

            if (!response.ok) {
                throw new Error(`Error en el servidor: ${response.status} ${response.statusText}`);
            }

            const result = await response.json();

            renderResults(result);
            displayMessage('Benchmark completado con éxito.', 'success');

        } catch (error) {
            console.error("Error al ejecutar benchmark:", error);
            displayMessage(`Fallo al conectar o ejecutar la prueba. Asegúrate de que la aplicación Spring Boot está corriendo en ${API_BASE_URL}. (${error.message})`, 'error');

            // Mostrar filas vacías si falla
            resultsBody.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-red-500">Error al cargar los resultados.</td></tr>';
            summaryDiv.classList.add('hidden');
        } finally {
            startButton.disabled = false;
            startButton.textContent = 'Iniciar Benchmark';
        }
    }

    // Inicializa la tabla con los resultados guardados si existen
    document.addEventListener('DOMContentLoaded', () => {
        // Intenta cargar el último resultado al iniciar la página
        fetch(`${API_BASE_URL}/result`)
            .then(response => {
                if (response.ok) return response.json();
                throw new Error('No hay resultados previos');
            })
            .then(renderResults)
            .catch(() => {
                // Ignorar si no hay resultados previos
            });
    });

</script>
</body>
</html>
